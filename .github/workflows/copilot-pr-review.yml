name: Copilot PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR diff
        id: pr-diff
        run: |
          # Get PR number from context
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "Analyzing PR #${PR_NUMBER}"
          
          # Fetch the PR head using simpler, more reliable approach
          git fetch origin pull/${PR_NUMBER}/head:pr-${PR_NUMBER}
          git diff origin/${{ github.base_ref }}...pr-${PR_NUMBER} > pr-diff.txt
          
          # Debug: Show diff file size
          ls -la pr-diff.txt
          
          # Check if diff exists and is not empty
          if [ ! -s pr-diff.txt ]; then
            echo "No changes detected in PR"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected - diff size: $(wc -l < pr-diff.txt) lines"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Generate AI Review Summary
        if: steps.pr-diff.outputs.has_changes == 'true'
        id: ai-review
        run: |
          # Create a more comprehensive review based on file changes
          DIFF_LINES=$(wc -l < pr-diff.txt)
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...pr-${PR_NUMBER} | wc -l)
          
          cat > review-output.md << EOF
          ## 🤖 Automated PR Review
          
          **Summary:** This PR contains ${FILES_CHANGED} file(s) with ${DIFF_LINES} lines of changes.
          
          ### Files Modified
          $(git diff --name-only origin/${{ github.base_ref }}...pr-${PR_NUMBER} | sed 's/^/- /')
          
          ### Analysis
          - ✅ **Change Detection**: Successfully identified modifications
          - 📊 **Scope**: $([ ${FILES_CHANGED} -lt 5 ] && echo "Small change" || echo "Medium/Large change")
          - 🔍 **Review Recommended**: Manual review by maintainers suggested
          
          ### Automated Checks
          - Configuration files: $(git diff --name-only origin/${{ github.base_ref }}...pr-${PR_NUMBER} | grep -E '\.(yml|yaml|json|toml)$' | wc -l) modified
          - Documentation: $(git diff --name-only origin/${{ github.base_ref }}...pr-${PR_NUMBER} | grep -E '\.(md|txt)$' | wc -l) modified  
          - Code files: $(git diff --name-only origin/${{ github.base_ref }}...pr-${PR_NUMBER} | grep -E '\.(js|ts|html|css|rb|py)$' | wc -l) modified
          
          ### Next Steps
          1. 👀 Review changes manually
          2. 🧪 Test functionality locally  
          3. ✅ Approve if changes look good
          4. 🚀 Merge when ready
          
          ---
          *Automated review generated at $(date)*
          EOF
          
          echo "review_created=true" >> $GITHUB_OUTPUT
      
      - name: Post Review Comment
        if: steps.ai-review.outputs.review_created == 'true'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file review-output.md
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Update PR with Labels  
        if: steps.ai-review.outputs.review_created == 'true'
        continue-on-error: true
        run: |
          # Try to add an automated-review label if it exists
          gh pr edit ${{ github.event.pull_request.number }} --add-label "automated-review" 2>/dev/null || echo "Label 'automated-review' does not exist, skipping"
        env:
          GH_TOKEN: ${{ github.token }}
